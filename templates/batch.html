{% extends "base.html" %}

{% block title %}Batch Processing - CardGen{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="page-header mb-4">
        <h1 class="page-title">
            <i class="fas fa-layer-group me-2"></i>
            Batch Processing
        </h1>
        <p class="page-subtitle">Generate multiple business cards from CSV data</p>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section mb-5">
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-info-circle me-2"></i>
                How It Works
            </h2>
            <div class="instruction-steps">
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="step-content">
                        <h3>üìã Prepare CSV File</h3>
                        <p>Create a CSV file with columns for each card field. Include name, job title, company, and contact information for each person.</p>
                        <div class="step-details">
                            <small><i class="fas fa-lightbulb text-warning me-1"></i>Tip: Use our template below to get started quickly</small>
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-upload"></i>
                    </div>
                    <div class="step-content">
                        <h3>‚öôÔ∏è Upload & Configure</h3>
                        <p>Upload your CSV file and select your preferred export format (PNG images or PDF documents).</p>
                        <div class="step-details">
                            <small><i class="fas fa-shield-alt text-success me-1"></i>Your data is processed securely and deleted after download</small>
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="step-content">
                        <h3>üì¶ Download ZIP</h3>
                        <p>Get all generated business cards organized in a convenient ZIP archive, ready for distribution or printing.</p>
                        <div class="step-details">
                            <small><i class="fas fa-compress-arrows-alt text-info me-1"></i>Automatically compressed for faster download</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Template Section -->
    <div class="template-section mb-5">
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-table me-2"></i>
                CSV Template & Format
            </h2>
            <div class="template-info">
                <div class="info-box mb-4">
                    <i class="fas fa-info-circle text-primary"></i>
                    <p><strong>üìä Column Structure:</strong> Your CSV file should include the following columns for best results:</p>
                </div>
                
                <div class="csv-columns">
                    <div class="column-group">
                        <h4><i class="fas fa-star text-warning me-2"></i>‚úÖ Required Columns</h4>
                        <div class="column-list">
                            <span class="column-tag required">
                                <i class="fas fa-user me-1"></i>name
                            </span>
                        </div>
                        <small class="text-muted">üìù This is the only mandatory field - all others are optional</small>
                    </div>
                    
                    <div class="column-group">
                        <h4><i class="fas fa-plus-circle text-info me-2"></i>üîß Optional Columns</h4>
                        <div class="column-list">
                            <span class="column-tag">
                                <i class="fas fa-briefcase me-1"></i>job_title
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-building me-1"></i>company
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-envelope me-1"></i>email
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-phone me-1"></i>phone
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-globe me-1"></i>website
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-map-marker-alt me-1"></i>address
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-share-alt me-1"></i>social_platform
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-at me-1"></i>social_handle
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-palette me-1"></i>template
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-paint-brush me-1"></i>color_scheme
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-font me-1"></i>font_family
                            </span>
                            <span class="column-tag">
                                <i class="fas fa-qrcode me-1"></i>include_qr
                            </span>
                        </div>
                        <small class="text-muted">üé® Customize design and add contact details as needed</small>
                    </div>
                </div>
            </div>
        
            <!-- Sample CSV -->
            <div class="csv-sample">
                <h4><i class="fas fa-code me-2"></i>üìÑ Sample CSV Content:</h4>
                <div class="code-block">
                    <div class="code-header">
                        <span><i class="fas fa-file-csv me-2"></i>business_cards.csv</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    <pre><code>name,job_title,company,email,phone,template,color_scheme
John Doe,Senior Developer,Tech Corp,john@techcorp.com,555-0123,modern,blue
Jane Smith,Marketing Manager,Creative Co,jane@creative.com,555-0456,elegant,purple
Bob Johnson,CEO,Startup Inc,bob@startup.com,555-0789,executive,black</code></pre>
                </div>
            </div>
            
            <!-- Download Template Button -->
            <div class="template-actions">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="downloadTemplate()">
                        <i class="fas fa-download me-2"></i>
                        üì• Download CSV Template
                    </button>
                    <div class="action-info">
                        <small><i class="fas fa-magic text-success me-1"></i>Pre-filled with sample data to get you started instantly</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h2 class="section-title">Upload & Process</h2>
        
        <form action="{{ url_for('batch_process') }}" method="POST" enctype="multipart/form-data" class="batch-form">
            <!-- File Upload -->
            <div class="form-group mb-4">
                <label class="form-label">CSV File</label>
                <div class="file-upload-zone" id="csv-upload-zone">
                    <input type="file" class="form-control" id="csv_file" name="csv_file" 
                           accept=".csv" required style="display: none;">
                    <div class="upload-content">
                        <i class="fas fa-file-csv"></i>
                        <h3>Drop CSV file here or tap to browse</h3>
                        <p>Maximum file size: 10MB</p>
                    </div>
                </div>
                <div class="file-info" id="file-info" style="display: none;">
                    <div class="file-details">
                        <i class="fas fa-file-csv"></i>
                        <div class="file-meta">
                            <div class="file-name" id="file-name"></div>
                            <div class="file-size" id="file-size"></div>
                        </div>
                        <button type="button" class="btn btn-link text-danger p-0" onclick="removeFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Format Selection -->
            <div class="form-group mb-4">
                <label class="form-label">Export Format</label>
                <div class="format-options">
                    <label class="format-option">
                        <input type="radio" name="export_format" value="png" checked>
                        <div class="format-card">
                            <i class="fas fa-image"></i>
                            <h4>PNG Images</h4>
                            <p>High-resolution images for digital use</p>
                        </div>
                    </label>
                    
                    <label class="format-option">
                        <input type="radio" name="export_format" value="pdf">
                        <div class="format-card">
                            <i class="fas fa-file-pdf"></i>
                            <h4>PDF Documents</h4>
                            <p>Vector-based documents for printing</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Processing Options -->
            <div class="form-group mb-4">
                <h3 class="form-label">Processing Options</h3>
                <div class="processing-options">
                    <div class="option-item">
                        <i class="fas fa-lightning-bolt text-warning"></i>
                        <div class="option-content">
                            <h4>Fast Processing</h4>
                            <p>Optimized for speed with standard templates</p>
                        </div>
                    </div>
                    
                    <div class="option-item">
                        <i class="fas fa-compress-arrows-alt text-info"></i>
                        <div class="option-content">
                            <h4>Auto Compression</h4>
                            <p>ZIP file will be automatically compressed</p>
                        </div>
                    </div>
                    
                    <div class="option-item">
                        <i class="fas fa-shield-alt text-success"></i>
                        <div class="option-content">
                            <h4>Secure Processing</h4>
                            <p>Files are processed securely and deleted after download</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg touch-target w-100" id="process-btn">
                    <i class="fas fa-cogs me-2"></i>
                    Process Cards
                </button>
            </div>
        </form>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status" style="display: none;">
        <div class="status-content">
            <div class="status-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h3>Processing Your Cards...</h3>
            <p>Please wait while we generate your business cards.</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" id="progress-bar"></div>
            </div>
            <div class="status-details" id="status-details">
                Initializing...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
const csvUploadZone = document.getElementById('csv-upload-zone');
const csvFileInput = document.getElementById('csv_file');
const fileInfo = document.getElementById('file-info');

csvUploadZone.addEventListener('click', () => {
    csvFileInput.click();
});

csvUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    csvUploadZone.classList.add('dragover');
});

csvUploadZone.addEventListener('dragleave', () => {
    csvUploadZone.classList.remove('dragover');
});

csvUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    csvUploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        csvFileInput.files = files;
        showFileInfo(files[0]);
    }
});

csvFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFileInfo(e.target.files[0]);
    }
});

function showFileInfo(file) {
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    
    csvUploadZone.style.display = 'none';
    fileInfo.style.display = 'block';
}

function removeFile() {
    csvFileInput.value = '';
    csvUploadZone.style.display = 'block';
    fileInfo.style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format option selection
document.querySelectorAll('input[name="export_format"]').forEach(input => {
    input.addEventListener('change', function() {
        document.querySelectorAll('.format-option').forEach(option => {
            option.classList.remove('selected');
        });
        this.closest('.format-option').classList.add('selected');
    });
});

// Form submission handling
document.querySelector('.batch-form').addEventListener('submit', function(e) {
    if (!csvFileInput.files.length) {
        e.preventDefault();
        alert('Please select a CSV file');
        return;
    }
    
    // Show processing status
    showProcessingStatus();
});

function showProcessingStatus() {
    document.querySelector('.upload-section').style.display = 'none';
    document.getElementById('processing-status').style.display = 'block';
    
    // Simulate progress
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const statusDetails = document.getElementById('status-details');
    
    const statusMessages = [
        'Reading CSV file...',
        'Validating data...',
        'Generating cards...',
        'Creating ZIP archive...',
        'Finalizing download...'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        
        const messageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (messageIndex < statusMessages.length) {
            statusDetails.textContent = statusMessages[messageIndex];
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            statusDetails.textContent = 'Download ready!';
        }
    }, 500);
}

// Download CSV template
function downloadTemplate() {
    const csvContent = `name,job_title,company,email,phone,website,address,social_platform,social_handle,template,color_scheme,font_family,include_qr
John Doe,Senior Developer,Tech Corp,john@techcorp.com,555-0123,https://techcorp.com,"123 Tech St, Silicon Valley",linkedin,johndoe,modern,blue,inter,true
Jane Smith,Marketing Manager,Creative Co,jane@creative.com,555-0456,https://creative.com,"456 Art Ave, NYC",twitter,janesmith,elegant,purple,montserrat,false
Bob Johnson,CEO,Startup Inc,bob@startup.com,555-0789,https://startup.com,"789 Innovation Blvd, Austin",github,bobjohnson,executive,black,roboto,true`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'business_cards_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Copy CSV content to clipboard
function copyToClipboard() {
    const csvContent = `name,job_title,company,email,phone,template,color_scheme
John Doe,Senior Developer,Tech Corp,john@techcorp.com,555-0123,modern,blue
Jane Smith,Marketing Manager,Creative Co,jane@creative.com,555-0456,elegant,purple
Bob Johnson,CEO,Startup Inc,bob@startup.com,555-0789,executive,black`;
    
    navigator.clipboard.writeText(csvContent).then(() => {
        // Show success notification
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(() => {
        alert('Unable to copy to clipboard. Please copy manually.');
    });
}

// Touch feedback for interactive elements
document.querySelectorAll('.format-option, .step, .option-item').forEach(element => {
    element.addEventListener('touchstart', function() {
        this.classList.add('touched');
    });
    
    element.addEventListener('touchend', function() {
        setTimeout(() => {
            this.classList.remove('touched');
        }, 150);
    });
});

// Initialize format selection
document.querySelector('input[name="export_format"]:checked').closest('.format-option').classList.add('selected');
</script>
{% endblock %}
