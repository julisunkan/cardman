{% extends "base.html" %}

{% block title %}Batch Processing - CardGen{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="page-header mb-4">
        <h1 class="page-title">
            <i class="fas fa-layer-group me-2"></i>
            Batch Processing
        </h1>
        <p class="page-subtitle">Generate multiple business cards from CSV data</p>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section mb-5">
        <h2 class="section-title">How It Works</h2>
        <div class="instruction-steps">
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>Prepare CSV File</h3>
                    <p>Create a CSV file with columns for each card field</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>Upload & Configure</h3>
                    <p>Upload your CSV and select export format</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3>Download ZIP</h3>
                    <p>Get all generated cards in a ZIP archive</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Template Section -->
    <div class="template-section mb-5">
        <h2 class="section-title">CSV Template</h2>
        <div class="template-info">
            <p>Your CSV file should include the following columns:</p>
            
            <div class="csv-columns">
                <div class="column-group">
                    <h4>Required Columns</h4>
                    <div class="column-list">
                        <span class="column-tag required">name</span>
                    </div>
                </div>
                
                <div class="column-group">
                    <h4>Optional Columns</h4>
                    <div class="column-list">
                        <span class="column-tag">job_title</span>
                        <span class="column-tag">company</span>
                        <span class="column-tag">email</span>
                        <span class="column-tag">phone</span>
                        <span class="column-tag">website</span>
                        <span class="column-tag">address</span>
                        <span class="column-tag">social_platform</span>
                        <span class="column-tag">social_handle</span>
                        <span class="column-tag">template</span>
                        <span class="column-tag">color_scheme</span>
                        <span class="column-tag">font_family</span>
                        <span class="column-tag">include_qr</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sample CSV -->
        <div class="csv-sample">
            <h4>Sample CSV Content:</h4>
            <div class="code-block">
                <pre><code>name,job_title,company,email,phone,template,color_scheme
John Doe,Senior Developer,Tech Corp,john@techcorp.com,555-0123,modern,blue
Jane Smith,Marketing Manager,Creative Co,jane@creative.com,555-0456,elegant,purple
Bob Johnson,CEO,Startup Inc,bob@startup.com,555-0789,executive,black</code></pre>
            </div>
        </div>
        
        <!-- Download Template Button -->
        <div class="template-actions">
            <button class="btn btn-outline-primary" onclick="downloadTemplate()">
                <i class="fas fa-download me-2"></i>
                Download Template
            </button>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h2 class="section-title">Upload & Process</h2>
        
        <form action="{{ url_for('batch_process') }}" method="POST" enctype="multipart/form-data" class="batch-form">
            <!-- File Upload -->
            <div class="form-group mb-4">
                <label class="form-label">CSV File</label>
                <div class="file-upload-zone" id="csv-upload-zone">
                    <input type="file" class="form-control" id="csv_file" name="csv_file" 
                           accept=".csv" required style="display: none;">
                    <div class="upload-content">
                        <i class="fas fa-file-csv"></i>
                        <h3>Drop CSV file here or tap to browse</h3>
                        <p>Maximum file size: 10MB</p>
                    </div>
                </div>
                <div class="file-info" id="file-info" style="display: none;">
                    <div class="file-details">
                        <i class="fas fa-file-csv"></i>
                        <div class="file-meta">
                            <div class="file-name" id="file-name"></div>
                            <div class="file-size" id="file-size"></div>
                        </div>
                        <button type="button" class="btn btn-link text-danger p-0" onclick="removeFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Export Format Selection -->
            <div class="form-group mb-4">
                <label class="form-label">Export Format</label>
                <div class="format-options">
                    <label class="format-option">
                        <input type="radio" name="export_format" value="png" checked>
                        <div class="format-card">
                            <i class="fas fa-image"></i>
                            <h4>PNG Images</h4>
                            <p>High-resolution images for digital use</p>
                        </div>
                    </label>
                    
                    <label class="format-option">
                        <input type="radio" name="export_format" value="pdf">
                        <div class="format-card">
                            <i class="fas fa-file-pdf"></i>
                            <h4>PDF Documents</h4>
                            <p>Vector-based documents for printing</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Processing Options -->
            <div class="form-group mb-4">
                <h3 class="form-label">Processing Options</h3>
                <div class="processing-options">
                    <div class="option-item">
                        <i class="fas fa-lightning-bolt text-warning"></i>
                        <div class="option-content">
                            <h4>Fast Processing</h4>
                            <p>Optimized for speed with standard templates</p>
                        </div>
                    </div>
                    
                    <div class="option-item">
                        <i class="fas fa-compress-arrows-alt text-info"></i>
                        <div class="option-content">
                            <h4>Auto Compression</h4>
                            <p>ZIP file will be automatically compressed</p>
                        </div>
                    </div>
                    
                    <div class="option-item">
                        <i class="fas fa-shield-alt text-success"></i>
                        <div class="option-content">
                            <h4>Secure Processing</h4>
                            <p>Files are processed securely and deleted after download</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg touch-target w-100" id="process-btn">
                    <i class="fas fa-cogs me-2"></i>
                    Process Cards
                </button>
            </div>
        </form>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status" style="display: none;">
        <div class="status-content">
            <div class="status-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h3>Processing Your Cards...</h3>
            <p>Please wait while we generate your business cards.</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" id="progress-bar"></div>
            </div>
            <div class="status-details" id="status-details">
                Initializing...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
const csvUploadZone = document.getElementById('csv-upload-zone');
const csvFileInput = document.getElementById('csv_file');
const fileInfo = document.getElementById('file-info');

csvUploadZone.addEventListener('click', () => {
    csvFileInput.click();
});

csvUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    csvUploadZone.classList.add('dragover');
});

csvUploadZone.addEventListener('dragleave', () => {
    csvUploadZone.classList.remove('dragover');
});

csvUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    csvUploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].name.endsWith('.csv')) {
        csvFileInput.files = files;
        showFileInfo(files[0]);
    }
});

csvFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        showFileInfo(e.target.files[0]);
    }
});

function showFileInfo(file) {
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    
    csvUploadZone.style.display = 'none';
    fileInfo.style.display = 'block';
}

function removeFile() {
    csvFileInput.value = '';
    csvUploadZone.style.display = 'block';
    fileInfo.style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format option selection
document.querySelectorAll('input[name="export_format"]').forEach(input => {
    input.addEventListener('change', function() {
        document.querySelectorAll('.format-option').forEach(option => {
            option.classList.remove('selected');
        });
        this.closest('.format-option').classList.add('selected');
    });
});

// Form submission handling
document.querySelector('.batch-form').addEventListener('submit', function(e) {
    if (!csvFileInput.files.length) {
        e.preventDefault();
        alert('Please select a CSV file');
        return;
    }
    
    // Show processing status
    showProcessingStatus();
});

function showProcessingStatus() {
    document.querySelector('.upload-section').style.display = 'none';
    document.getElementById('processing-status').style.display = 'block';
    
    // Simulate progress
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const statusDetails = document.getElementById('status-details');
    
    const statusMessages = [
        'Reading CSV file...',
        'Validating data...',
        'Generating cards...',
        'Creating ZIP archive...',
        'Finalizing download...'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        
        const messageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (messageIndex < statusMessages.length) {
            statusDetails.textContent = statusMessages[messageIndex];
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            statusDetails.textContent = 'Download ready!';
        }
    }, 500);
}

// Download CSV template
function downloadTemplate() {
    const csvContent = `name,job_title,company,email,phone,website,address,social_platform,social_handle,template,color_scheme,font_family,include_qr
John Doe,Senior Developer,Tech Corp,john@techcorp.com,555-0123,https://techcorp.com,"123 Tech St, Silicon Valley",linkedin,johndoe,modern,blue,inter,true
Jane Smith,Marketing Manager,Creative Co,jane@creative.com,555-0456,https://creative.com,"456 Art Ave, NYC",twitter,janesmith,elegant,purple,montserrat,false
Bob Johnson,CEO,Startup Inc,bob@startup.com,555-0789,https://startup.com,"789 Innovation Blvd, Austin",github,bobjohnson,executive,black,roboto,true`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'business_cards_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Touch feedback for interactive elements
document.querySelectorAll('.format-option, .step, .option-item').forEach(element => {
    element.addEventListener('touchstart', function() {
        this.classList.add('touched');
    });
    
    element.addEventListener('touchend', function() {
        setTimeout(() => {
            this.classList.remove('touched');
        }, 150);
    });
});

// Initialize format selection
document.querySelector('input[name="export_format"]:checked').closest('.format-option').classList.add('selected');
</script>
{% endblock %}
